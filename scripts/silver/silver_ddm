
-----------------------------------------------
insert into silver.source_crm_cust_info (
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date)
select 
cst_id,
cst_key,
trim(cst_firstname) as cst_firstname,
trim(cst_lastname) as cst_lastname,
case when UPPER(cst_marital_status ) = 'S' then 'Single'
		when UPPER(cst_marital_status) = 'M' then 'Married'
		else 'n/a'
end cst_marital_status,
	case when UPPER(cst_gndr) = 'F' then 'Female'
		when UPPER(cst_gndr) = 'M' then 'Male'
		else 'n/a'
end cst_gndr,
cst_create_date
	from (
select * ,
row_number() over (partition by cst_id order by cst_create_date DESC) as flag_last
from bronze.source_crm_cust_info)
where flag_last = 1 and cst_id is not NULL



-----------------------------------------------
insert into silver.source_crm_prd_info(
		prd_id,
		cat_id,
		prd_key,
		prd_nm,
		prd_cost,
		prd_line,
		prd_start_dt,
		prd_end_dt
)
select prd_id,
		replace(substring(prd_key, 1, 5), '-', '_') as cat_id,
		substring(prd_key, 7, LENGTH(prd_key)) as prd_key,
		prd_nm,
		COALESCE(prd_cost, 0) as prd_cost,
		case UPPER(TRIM(prd_line))
			when 'M' then 'Mountain'
			when 'R' then 'Road'
			when 's' then 'Other Sales'
			when 'T' then 'Touring'
			else 'n/a'
		end as prd_line,
		cast(prd_start_dt as DATE) as prd_start_dt,
		cast(lead(prd_start_dt) over (partition by prd_key order by prd_start_dt)-1 as DATE) as prd_end_dt
from bronze.source_crm_prd_info
----------------------------------------------
insert into silver.source_crm_sales_details (
		sls_ord_num,
		sls_prd_key,
		sls_cust_id,
		sls_order_dt,
		sls_ship_dt,
		sls_due_dt,
		sls_sales,
		sls_quantity,
		sls_price)
select 
		sls_ord_num,
		sls_prd_key,
		sls_cust_id,
		case when sls_order_dt = 0 or length(cast(sls_order_dt as TEXT)) != 8 then NULL
			else cast(cast(sls_order_dt as VARCHAR) as DATE)
		end sls_order_dt,
		case when sls_ship_dt = 0 or length(cast(sls_ship_dt as TEXT)) != 8 then NULL
			else cast(cast(sls_ship_dt as VARCHAR) as DATE)
		end sls_ship_dt,
		case when sls_due_dt = 0 or length(cast(sls_due_dt as TEXT)) != 8 then NULL
			else cast(cast(sls_due_dt as VARCHAR) as DATE)
		end sls_due_dt,
		case when sls_sales is null or sls_sales <= 0 or sls_sales != sls_quantity * ABS(sls_price)
			then sls_quantity * ABS(sls_price)
			else sls_sales
		end as sls_sales,
		sls_quantity,
		case when sls_price is null or sls_price <= 0 
			then sls_sales/nullif(sls_quantity, 0)
			else sls_price
		end as sls_price
from bronze.source_crm_sales_details
-------------------------------------------------------
insert into silver.source_erp_cust_az12(
	cid,
	bdate,
	gen)
select 
	case when cid like 'NAS%' then substring(cid, 4)
		else cid
	end as cid,
	case when bdate > current_date then NULL
	else bdate
	end as bdat,
	case when upper(trim(gen)) in ('F', 'FEMALE') then 'Female'
		 when upper(trim(gen)) in  ('M', 'MALE') then 'Male'
		else 'n/a'
	end as gen
from bronze.source_erp_cust_az12
	
	
